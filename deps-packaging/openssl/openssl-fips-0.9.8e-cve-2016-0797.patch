diff -cr openssl-0.9.8zh/crypto/bn/bn.h openssl-0.9.8zh-new/crypto/bn/bn.h
*** openssl-0.9.8zh/crypto/bn/bn.h	2015-12-03 15:59:07.000000000 +0100
--- openssl-0.9.8zh-new/crypto/bn/bn.h	2016-03-15 13:14:10.599057268 +0100
***************
*** 76,81 ****
--- 76,82 ----
  # ifndef OPENSSL_NO_FP_API
  #  include <stdio.h>            /* FILE */
  # endif
+ # include <limits.h>
  # include <openssl/ossl_typ.h>
  
  #ifdef  __cplusplus
***************
*** 704,711 ****
  
  /* library internal functions */
  
! # define bn_expand(a,bits) ((((((bits+BN_BITS2-1))/BN_BITS2)) <= (a)->dmax)?\
!         (a):bn_expand2((a),(bits+BN_BITS2-1)/BN_BITS2))
  # define bn_wexpand(a,words) (((words) <= (a)->dmax)?(a):bn_expand2((a),(words)))
  BIGNUM *bn_expand2(BIGNUM *a, int words);
  # ifndef OPENSSL_NO_DEPRECATED
--- 705,713 ----
  
  /* library internal functions */
  
! #define bn_expand(a,bits) (bits > (INT_MAX - BN_BITS2 + 1)?\
! 	NULL:(((((bits+BN_BITS2-1))/BN_BITS2)) <= (a)->dmax)? \
!  	(a):bn_expand2((a),(bits+BN_BITS2-1)/BN_BITS2))
  # define bn_wexpand(a,words) (((words) <= (a)->dmax)?(a):bn_expand2((a),(words)))
  BIGNUM *bn_expand2(BIGNUM *a, int words);
  # ifndef OPENSSL_NO_DEPRECATED
diff -cr openssl-0.9.8zh/crypto/bn/bn_print.c openssl-0.9.8zh-new/crypto/bn/bn_print.c
*** openssl-0.9.8zh/crypto/bn/bn_print.c	2015-12-03 15:59:07.000000000 +0100
--- openssl-0.9.8zh-new/crypto/bn/bn_print.c	2016-03-15 13:12:18.479054605 +0100
***************
*** 58,63 ****
--- 58,64 ----
  
  #include <stdio.h>
  #include <ctype.h>
+ #include <limits.h>
  #include "cryptlib.h"
  #include <openssl/buffer.h>
  #include "bn_lcl.h"
***************
*** 189,195 ****
          a++;
      }
  
!     for (i = 0; isxdigit((unsigned char)a[i]); i++) ;
  
      num = i + neg;
      if (bn == NULL)
--- 190,198 ----
          a++;
      }
  
!     for (i=0; i <= (INT_MAX/4) && isxdigit((unsigned char) a[i]); i++);
!     if (i > INT_MAX/4)
!         goto err;
  
      num = i + neg;
      if (bn == NULL)
***************
*** 204,210 ****
          BN_zero(ret);
      }
  
!     /* i is the number of hex digests; */
      if (bn_expand(ret, i * 4) == NULL)
          goto err;
  
--- 207,213 ----
          BN_zero(ret);
      }
  
!     /* i is the number of hex digits; */
      if (bn_expand(ret, i * 4) == NULL)
          goto err;
  
***************
*** 260,266 ****
          a++;
      }
  
!     for (i = 0; isdigit((unsigned char)a[i]); i++) ;
  
      num = i + neg;
      if (bn == NULL)
--- 263,271 ----
          a++;
      }
  
!     for (i=0; i <= (INT_MAX/4) && isdigit((unsigned char) a[i]); i++);
!     if (i > INT_MAX/4)
!         goto err;
  
      num = i + neg;
      if (bn == NULL)
***************
*** 278,284 ****
          BN_zero(ret);
      }
  
!     /* i is the number of digests, a bit of an over expand; */
      if (bn_expand(ret, i * 4) == NULL)
          goto err;
  
--- 283,289 ----
          BN_zero(ret);
      }
  
!     /* i is the number of digits, a bit of an over expand; */
      if (bn_expand(ret, i * 4) == NULL)
          goto err;
  
