#!/bin/sh

set -e

usage() {
  echo
  echo "Usage: build-remote [--wix-machine=<user@host>]"
  echo "                    [--cross-target=<target>]"
  echo "                    [--project=<project>]"
  echo "                    [--branch=<branch>]"
  echo "                    [--source=<url>]"
  echo "                    [--workdir=<path>]"
  echo "				    [--role=<hub|agent>]"
  echo "					[--version=<version string>]"
  echo "                    [--full|--release|--debug|--docs|--release-and-debug]"
  echo "                    <user@host>"
  echo
  echo "Project defaults to 'nova'"
  echo "Branch defaults to 'master'"
  echo "Workdir  defaults to '/var/cfengine'"
  echo "Build type defaults to quick. You may request a full build using --full"
  echo "Source defaults to git@github.com:cfengine/"
  echo
  echo "WiX machine and cross-compilation are not used by default"
  echo
}

opts() {
  OPTS=`getopt -o p:b:w:c:d:h --long project:,branch:,wix-machine:,cross-target:,workdir:,source:,role:,version:,releasenumber:,full,release,debug,docs,release-and-debug,help -n build-remote -- "$@"`

  eval set -- "$OPTS"

  if [ $? != 0 ]; then
    usage
    exit 1
  fi

  DOCS=no
  PROJECT=nova
  BRANCH=master
  BUILD_TYPE=quick
  SOURCE=git@github.com:cfengine
  BUILD_NUMBER=666
  EXPLICIT_ROLE=

  while true; do
    case "$1" in
      -p|--project)
        PROJECT="$2"
        shift 2;;
      -b|--branch)
        BRANCH="$2"
        shift 2;;
      -w|--wix-machine)
        WIX_MACHINE="$2"
        shift 2;;
      -c|--cross-target)
        CROSS_TARGET="$2"
        shift 2;;
      -d|--workdir)
         PREFIX="$2"
         shift 2;;
      --full)
        BUILD_TYPE=full
        shift;;
      --release)
        BUILD_TYPE=release
        shift;;
      --debug)
        BUILD_TYPE=debug
        shift;;
	  --release-and-debug)
	    BUILD_TYPE=debug_and_release
		shift;;
      --docs)
        DOCS=yes
        shift;;
      --source)
        SOURCE="$2"
        shift 2;;
      --role)
	    EXPLICIT_ROLE="$2"
		shift 2;;
	  --version)
	    EXPLICIT_VERSION="$2"
		shift 2;;
      --releasenumber)
           EXPLICIT_RELEASE="$2"
		shift 2;;
      -h|--help)
        usage
        exit 0;;
      --)
        shift
        break;;
      *)
        echo "Internal error!"
        exit 1;;
    esac
  done

  if [ $# -ne 1 ]; then
    usage
    exit 1
  fi
  
  REPOSITORY=$PROJECT-$BRANCH
  HOST=$1

  export PROJECT BRANCH WIX_MACHINE CROSS_TARGET HOST BUILD_TYPE BUILD_NUMBER DOCS EXPLICIT_ROLE EXPLICIT_VERSION

  export SCHEDULER=$PROJECT-$BRANCH-localbuild
}

prepare_workdir() {
  mkdir -p "workdir-$PROJECT-$BRANCH-$HOST"
  rm -rf "workdir-$PROJECT-$BRANCH-$HOST"/*
  cd "workdir-$PROJECT-$BRANCH-$HOST"
}

checkout() {
  mkdir -p build
  rsync -avr --exclude='workdir-*' ../ build/autobuild
  (cd build/autobuild && git add -A || :; git commit -a -m "Commit for build" || :)

  REPOS="core"
  
  case "$PROJECT" in
     nova)
      REPOS="$REPOS nova design-center mission-portal"
  esac

  case "$PROJECT-$BRANCH" in
    community-master)
      git clone $SOURCE/core build/core
      ;;
    community-3.4.x)
      git clone $SOURCE/core build/core
      (cd build/core && git checkout 3.4.x) || false
     ;;
    community-3.3.x)
      git clone $SOURCE/core build/core
      (cd build/core && git checkout -b 3.3.x remotes/origin/3.3.x || git checkout 3.3.x) || false
      ;;
    community-3.4.*)
      VERSION=$BRANCH
      git clone $SOURCE/core build/core
      (cd build/core && git checkout $VERSION) || false
      ;;
    nova-2.2.2)
      VERSION=$BRANCH
      git clone $SOURCE/nova build/nova
      (cd build/nova && git checkout $VERSION) || false
      git clone $SOURCE/core build/core
      (cd build/core && git checkout 3.3.6) || false
      ;;
    nova-3.5.x)
      VERSION=$BRANCH
      git clone $SOURCE/nova build/nova
      (cd build/nova && git checkout $VERSION) || false
      git clone $SOURCE/core build/core
      (cd build/core && git checkout $VERSION) || false
      git clone $SOURCE/mission-portal build/mission-portal
      git clone $SOURCE/design-center build/design-center
      (cd build/design-center && git checkout $VERSION)
      ;;
    nova-2.2.*)
      VERSION=$BRANCH
      git clone $SOURCE/nova build/nova
      (cd build/nova && git checkout $VERSION) || false
      git clone $SOURCE/core build/core
      (cd build/core && git checkout -b 3.3.x remotes/origin/3.3.x || git checkout 3.3.x) || false
      ;;
    nova-master)
      git clone $SOURCE/core build/core
      git clone $SOURCE/nova build/nova
	  git clone $SOURCE/mission-portal build/mission-portal
      git clone $SOURCE/design-center build/design-center
      ;;
    nova-stable)
      git clone $SOURCE/core build/core
      (cd build/core && git checkout -b 3.4.x remotes/origin/3.4.x || git checkout 3.4.1n) || false
      git clone $SOURCE/nova build/nova
      (cd build/nova && git checkout -b 3.0.x remotes/origin/3.0.x || git checkout 3.0.0) || false
      git clone $SOURCE/mission-portal build/mission-portal
      (cd build/mission-portal && git checkout -b 3.0.x remotes/origin/3.0.x || git checkout 3.0.0) || false
      ;;
    *)
       for i in $REPOS;
         do
         git clone $SOURCE/$i build/$i
         (cd build/$i && git checkout -b $BRANCH remotes/origin/$BRANCH || git checkout $BRANCH) || false
         done
  
  esac
}

run() {
  NAME="$1"
  shift
  echo "---> $NAME"
  if ! "$@" > "$NAME.log" 2>&1; then
    echo "Failed. See the $NAME.log. Last lines are:"
    tail $NAME.log
    exit 1
  fi
}

local_script() {
  SCRIPT="$1"
  run "$SCRIPT" "build/autobuild/build-scripts/$SCRIPT" "$HOST"
}

remote_script() {
  SCRIPT="$1"
  ENVVARS="PROJECT=$PROJECT"
  if [ -n "$CROSS_TARGET" ]; then
    ENVVARS="$ENVVARS CROSS_TARGET=$CROSS_TARGET"
  fi
  if [ -n "$WIX_MACHINE" ]; then
    ENVVARS="$ENVVARS WIX_MACHINE=$WIX_MACHINE"
  fi
  if [ -n "$BUILD_TYPE" ]; then
    ENVVARS="$ENVVARS BUILD_TYPE=$BUILD_TYPE"
  fi
  if [ -n "$BUILD_NUMBER" ]; then
    ENVVARS="$ENVVARS BUILD_NUMBER=$BUILD_NUMBER"
  fi
  if [ -n "$PREFIX" ]; then
    ENVVARS="$ENVVARS BUILDPREFIX=$PREFIX"
  fi

  if [ -n "$EXPLICIT_RELEASE" ]; then
    ENVVARS="$ENVVARS EXPLICIT_RELEASE=$EXPLICIT_RELEASE"
  fi

  ENVVARS="$ENVVARS BRANCH=$REPOSITORY"
  ENVVARS="$ENVVARS EXPLICIT_ROLE=$EXPLICIT_ROLE"
  ENVVARS="$ENVVARS EXPLICIT_VERSION=$EXPLICIT_VERSION"

  run "$SCRIPT" ssh -o BatchMode=yes "$HOST" env $ENVVARS build/autobuild/build-scripts/"$SCRIPT"
}

build_docs() {
  remote_script configure-docs
  remote_script compile
  remote_script upload-docs
}

build() {
  remote_script configure
  remote_script compile
  case "$BUILD_TYPE" in
    debug_and_release)
	  remote_script produce-debug-symbols
	  ;;
  esac
  remote_script test
  remote_script package
  remote_script prepare-results

  local_script transfer-results
  local_script install-results
  local_script clean-results
}

common_build() {

  checkout
  local_script autogen
  local_script transfer-to-buildmachine
  remote_script clean-buildmachine
  remote_script install-dependencies

  case "$DOCS" in
    yes)
      build_docs;;
    no)
      build;;
  esac
}

opts "$@"
prepare_workdir
common_build
